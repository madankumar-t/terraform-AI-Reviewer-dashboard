# Architecture Diagrams

## ASCII Architecture Diagrams

### 1. Complete System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           MANAGEMENT ACCOUNT                                  │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  AWS Organizations                                                    │   │
│  │  - Service Control Policies (SCPs)                                  │   │
│  │  - Consolidated Billing                                             │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  IAM Identity Center                                                  │   │
│  │  - SAML Provider (Azure Entra ID)                                    │   │
│  │  - SCIM Provisioning                                                 │   │
│  │  - Permission Sets                                                   │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Security Hub (Aggregator)                                           │   │
│  │  GuardDuty (Organization-wide)                                         │   │
│  │  CloudTrail (Organization Trail)                                     │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Organization
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
┌──────────────┐          ┌──────────────┐          ┌──────────────┐
│   SHARED     │          │ APPLICATION  │          │ APPLICATION  │
│  SERVICES    │          │   ACCOUNT    │          │   ACCOUNT    │
│   ACCOUNT    │          │ (Production) │          │  (Staging)   │
└──────────────┘          └──────────────┘          └──────────────┘
        │                           │                           │
        │                           │                           │
        └───────────────────────────┼───────────────────────────┘
                                    │
                            Transit Gateway
                                    │
                                    ▼
```

### 2. Application Account Detailed Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        APPLICATION ACCOUNT (Production)                     │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                           VPC (10.0.0.0/16)                          │ │
│  │                                                                        │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│  │  │ Public Subnet│  │Private Subnet │  │Isolated Subnet│              │ │
│  │  │ 10.0.1.0/24  │  │ 10.0.2.0/24   │  │ 10.0.3.0/24   │              │ │
│  │  │              │  │               │  │               │              │ │
│  │  │ NAT Gateway  │  │ Lambda ENI    │  │ (Future RDS)   │              │ │
│  │  │ IGW          │  │               │  │               │              │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│  │                                                                        │ │
│  │  ┌──────────────────────────────────────────────────────────────┐    │ │
│  │  │              VPC ENDPOINTS (Interface)                       │    │ │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │    │ │
│  │  │  │ Secrets Mgr   │  │ CloudWatch   │  │ DynamoDB     │      │    │ │
│  │  │  │ (Interface)   │  │ Logs         │  │ (Gateway)    │      │    │ │
│  │  │  └──────────────┘  │ (Interface)  │  └──────────────┘      │    │ │
│  │  │                     └──────────────┘                        │    │ │
│  │  └──────────────────────────────────────────────────────────────┘    │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                         LAMBDA FUNCTIONS                             │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│  │  │ API Handler  │  │AI Reviewer   │  │Webhook Handler│              │ │
│  │  │ (512 MB)     │  │ (2048 MB)    │  │ (512 MB)      │              │ │
│  │  │ 30s timeout  │  │ 300s timeout │  │ 30s timeout    │              │ │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │ │
│  │         │                  │                  │                       │ │
│  │         └──────────────────┼──────────────────┘                       │ │
│  │                            │                                          │ │
│  │                            ▼                                          │ │
│  │                  ┌──────────────────┐                                 │ │
│  │                  │  DynamoDB       │                                 │ │
│  │                  │  (VPC Endpoint) │                                 │ │
│  │                  └──────────────────┘                                 │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                         API GATEWAY                                  │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│  │  │ GET /reviews │  │POST /reviews │  │POST /webhook │              │ │
│  │  │ GET /analytics│ │PUT /reviews  │  │              │              │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│  │                            │                                          │ │
│  │                            ▼                                          │ │
│  │                    Lambda Functions                                   │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │                         SECURITY SERVICES                            │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│  │  │ Secrets Mgr  │  │ KMS (CMK)    │  │ IAM Roles    │              │ │
│  │  │ (API Keys)   │  │ (Encryption)  │  │ (Least Priv) │              │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Transit Gateway
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SHARED SERVICES ACCOUNT                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  Transit Gateway (Hub)                                               │  │
│  │  Route 53 Private Hosted Zones                                       │  │
│  │  Bedrock VPC Endpoint (PrivateLink)                                  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3. Network Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           INTERNET (Untrusted)                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTPS/TLS 1.2+
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CLOUDFRONT + WAF                                    │
│  - DDoS Protection                                                          │
│  - Rate Limiting                                                           │
│  - Geographic Restrictions                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API GATEWAY (Public)                                │
│  - Request Validation                                                       │
│  - Authentication (Lambda Authorizer)                                      │
│  - Rate Limiting                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ IAM Authentication
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LAMBDA: API HANDLER                                      │
│  - Request Processing                                                       │
│  - Authorization                                                            │
│  - Business Logic                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ VPC Endpoint
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DYNAMODB (VPC Endpoint)                             │
│  - Encrypted at Rest (KMS)                                                  │
│  - Encrypted in Transit (TLS)                                              │
│  - Access Logged (CloudTrail)                                               │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    LAMBDA: AI REVIEWER                                      │
│  - Terraform Code Analysis                                                  │
│  - AI Service Integration                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ VPC Endpoint
                                    │ Transit Gateway
                                    │ PrivateLink
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│              SHARED SERVICES: BEDROCK (PrivateLink)                         │
│  - Private Connectivity                                                     │
│  - No Internet Exposure                                                     │
│  - IAM Authorization                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4. Identity and Access Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           USER / SERVICE                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 1. Login Request
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        AZURE ENTRA ID                                       │
│  - User Authentication                                                      │
│  - MFA Verification                                                         │
│  - Group Membership                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 2. SAML Assertion / OIDC Token
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    AWS IAM IDENTITY CENTER                                   │
│  (Management Account)                                                       │
│  - SAML Provider                                                            │
│  - SCIM Provisioning                                                        │
│  - Permission Set Assignment                                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 3. Assume Role
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    APPLICATION ACCOUNT                                      │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  IAM Role (e.g., PowerUserRole)                                      │   │
│  │  - Session Duration: 1 hour                                          │   │
│  │  - MFA Required                                                       │   │
│  │  - Session Policies Applied                                            │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  Lambda Execution Role                                                │   │
│  │  - Least Privilege                                                    │   │
│  │  - Resource-Based Policies                                            │   │
│  │  - Tag-Based Access Control                                           │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5. Data Flow: Review Creation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           FRONTEND (Next.js)                                │
│  - User submits Terraform code                                              │
│  - OAuth token included                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ POST /api/reviews
                                    │ Authorization: Bearer <token>
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    API GATEWAY                                              │
│  - Request received                                                         │
│  - Lambda Authorizer invoked                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Token Validation
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│              LAMBDA AUTHORIZER                                             │
│  - Validate Azure Entra ID token                                           │
│  - Extract user info                                                        │
│  - Check permissions                                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Authorized
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LAMBDA: API HANDLER                                      │
│  - Parse request                                                            │
│  - Validate input                                                           │
│  - Create review record                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ PutItem
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DYNAMODB                                            │
│  - Store review (status: pending)                                           │
│  - Encrypted (KMS)                                                          │
│  - Version: 1                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Async Invoke
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LAMBDA: AI REVIEWER                                      │
│  - Update status: in_progress                                               │
│  - Call AI Service                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ API Call
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│              BEDROCK (via PrivateLink)                                     │
│  - Analyze Terraform code                                                   │
│  - Generate findings                                                        │
│  - Return structured JSON                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Results
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LAMBDA: AI REVIEWER                                      │
│  - Process AI results                                                       │
│  - Update review record                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ UpdateItem
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DYNAMODB                                            │
│  - Update review (status: completed)                                        │
│  - Store AI results                                                         │
│  - Version: 2                                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Poll for updates
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           FRONTEND                                          │
│  - Display results                                                          │
│  - Show risk scores                                                         │
│  - Display findings                                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6. Security Boundary Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    EXTERNAL (UNTRUSTED ZONE)                                │
│  - Internet                                                                 │
│  - Public Users                                                             │
│  - Third-party Services                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                            │
                            │ HTTPS/TLS 1.2+
                            │ WAF Protection
                            │ DDoS Mitigation
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DMZ (SEMI-TRUSTED ZONE)                                  │
│  - CloudFront                                                               │
│  - WAF                                                                      │
│  - API Gateway (Public)                                                    │
│  - Rate Limiting                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                            │
                            │ IAM Authentication
                            │ Token Validation
                            │ MFA Required
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│              APPLICATION LAYER (TRUSTED ZONE)                               │
│  - Lambda Functions                                                         │
│  - VPC Endpoints                                                            │
│  - IAM Roles (Least Privilege)                                              │
│  - Encryption in Transit                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                            │
                            │ VPC Endpoints
                            │ Private Connectivity
                            │ Resource Policies
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DATA LAYER (HIGHLY TRUSTED ZONE)                        │
│  - DynamoDB                                                                 │
│  - Secrets Manager                                                         │
│  - KMS                                                                      │
│  - Encryption at Rest                                                        │
│  - Access Logging                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                            │
                            │ PrivateLink
                            │ Transit Gateway
                            │ Cross-Account IAM
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│              SHARED SERVICES (TRUSTED ZONE)                                 │
│  - Bedrock (PrivateLink)                                                   │
│  - Transit Gateway                                                         │
│  - Route 53 Private Zones                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                            │
                            │ SAML/SCIM
                            │ IAM Identity Center
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│              IDENTITY PROVIDER (CRITICAL ZONE)                               │
│  - Azure Entra ID                                                           │
│  - IAM Identity Center                                                      │
│  - MFA Enforcement                                                          │
│  - Audit Logging                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7. Compliance Evidence Collection Points

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    EVIDENCE COLLECTION POINTS                               │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                      │
│  │ CloudTrail  │  │ CloudWatch   │  │ AWS Config    │                      │
│  │ - All API   │  │ - Metrics     │  │ - Config      │                      │
│  │   calls     │  │ - Logs       │  │   Snapshots   │                      │
│  │ - IAM       │  │ - Alarms     │  │ - Compliance  │                      │
│  │   events    │  │              │  │   Reports     │                      │
│  └──────────────┘  └──────────────┘  └──────────────┘                      │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                      │
│  │ Security    │  │ GuardDuty    │  │ IAM Identity │                      │
│  │ Hub         │  │ - Findings   │  │ Center       │                      │
│  │ - Findings  │  │ - Alerts     │  │ - Sign-in    │                      │
│  │ - Compliance│  │              │  │   Logs       │                      │
│  └──────────────┘  └──────────────┘  └──────────────┘                      │
│                                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                      │
│  │ Terraform   │  │ Git          │  │ S3 Evidence  │                      │
│  │ State       │  │ - Commits    │  │ - Reports    │                      │
│  │ - Changes   │  │ - Reviews    │  │ - Snapshots  │                      │
│  └──────────────┘  └──────────────┘  └──────────────┘                      │
│                                                                              │
│                            ▼                                                 │
│                                                                              │
│              ┌──────────────────────────┐                                   │
│              │  EVIDENCE STORAGE (S3)    │                                   │
│              │  - Versioned             │                                   │
│              │  - Encrypted (KMS)       │                                   │
│              │  - Access Logged         │                                   │
│              │  - Glacier (Archive)     │                                   │
│              └──────────────────────────┘                                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

